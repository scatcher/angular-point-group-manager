"use strict";angular.module("angularPoint").controller("apGroupManagerCtrl",["$scope","$q","$timeout","$filter","_","ngTableParams","apConfig","apDataService","toastr",function(a,b,c,d,e,f,g,h,i){function j(){h.getCurrentSite().then(function(b){a.state.siteUrl=b}),b.all(w(),x()).then(function(){a.updateTab("Users"),console.log(a)})}function k(){var a=this,b={all:[],available:[],selectedAvailable:[],assigned:[],selectedAssigned:[],filter:""};e.extend(a,b),a.clearSelected=function(){a.selectedAvailable.length=0,a.selectedAssigned.length=0}}function l(b,c){var d=[],f=[],g=[],h=a[c];h.available.length=0,h.selectedAvailable.length=0,h.assigned.length=0,h.selectedAssigned.length=0,e.each(b,function(a){d.push(a.ID)}),e.each(h.all,function(a){e.indexOf(d,a.ID)>-1?g.push(a):f.push(a)}),Array.prototype.push.apply(h.available,f),Array.prototype.push.apply(h.assigned,g),console.log(a)}function m(){var c=b.defer();return i.info("Retrieving an updated list of groups for the current user"),h.getCollection({webUrl:a.state.siteUrl,operation:"GetGroupCollectionFromUser",userLoginName:a.groups.filter.LoginName}).then(function(a){l(a,"groups"),c.resolve(a)}),c.promise}function n(c){var d=b.defer();return i.info("Retrieving an updated list of users for the current group"),h.getCollection({webUrl:a.state.siteUrl,groupName:c.Name,operation:"GetUserCollectionFromGroup"}).then(function(a){l(a,"users"),d.resolve(a)},function(){i.error("Please verify that you have sufficient permissions to view members of this group"),d.resolve([])}),d.promise}function o(b){v(),a.state.activeTab=b,"Groups"===b?a.updateAvailableGroups().then(function(){}):a.updateAvailableUsers(a.users.filter).then(function(){})}function p(b){a.groups.filter=b,a.updateTab("Groups")}function q(b){a.users.filter=b,a.updateTab("Users")}function r(){a.updatePermissions("AddUserToGroup",a.users.assigned,[a.state.targetGroup]).then(function(b){i.success(b.length+" users successfully merged."),a.state.sourceGroup="",a.state.targetGroup=""})}function s(d,f,j){var k=b.defer();if(f.length){i.info("Processing your request");var l=[];e.each(f,function(f){e.each(j,function(e){var i=b.defer();g.offline?c(function(){}):h.serviceWrapper({webUrl:a.state.siteUrl,filterNode:"User",operation:d,groupName:e.Name,userLoginName:f.LoginName}).then(function(a){i.resolve(a)}),l.push(i.promise)})}),a.users.clearSelected(),a.groups.clearSelected(),b.all(l).then(function(b){i.success("AddUserToGroup"===d?"User successfully added":"User successfully removed"),g.offline||("Users"===a.state.activeTab?a.updateAvailableUsers(a.users.filter):a.updateAvailableGroups()),k.resolve(b)},function(){i.error("There was a problem removing the user")})}else i.warning("Please make a selection");return k.promise}function t(){return new f({page:1,count:30,sorting:{title:"asc"}},{total:a.users.all.length,getData:function(b,c){console.time("Filtering");var f=a.users.all;f=d("filter")(f,function(b){var c=!1;if(""===a.state.userFilter)return!0;var d=["ID","Name","Email"],f=a.state.userFilter.toLowerCase();return e.each(d,function(a){-1!==b[a].toLowerCase().indexOf(f)&&(c=!0)}),c}),c.total(f.length),b.resolve(f.slice((c.page()-1)*c.count(),c.page()*c.count()))}})}function u(){return new f({page:1,count:30,sorting:{title:"asc"}},{total:a.groups.all.length,getData:function(b,c){console.time("Filtering");var f=a.groups.all;f=d("filter")(f,function(b){var c=!1;if(""===a.state.groupFilter)return!0;var d=["ID","Name","Description"],f=a.state.groupFilter.toLowerCase();return e.each(d,function(a){-1!==b[a].toLowerCase().indexOf(f)&&(c=!0)}),c}),c.total(f.length),b.resolve(f.slice((c.page()-1)*c.count(),c.page()*c.count()))}})}function v(){a.users.filter=a.users.filter||a.groups.all[0],a.groups.filter=a.groups.filter||a.users.all[0]}function w(){var c=b.defer();return h.getCollection({webUrl:a.state.siteUrl,operation:"GetUserCollectionFromSite"}).then(function(b){e.each(b,function(b){b.Email&&a.users.all.push(b)}),c.resolve(a.users.all)}),c.promise}function x(){var c=b.defer();return h.getCollection({webUrl:a.state.siteUrl,operation:"GetGroupCollectionFromSite"}).then(function(b){Array.prototype.push.apply(a.groups.all,b),c.resolve(a.groups.all)}),c.promise}return a.assignedOptions=[],a.availableOptions=[],a.groupDetailsLink=q,a.groups=new k,a.groupsTable=u(),a.mergeGroups=r,a.tabContents={},a.updateAvailableGroups=m,a.updateAvailableUsers=n,a.updatePermissions=s,a.updateTab=o,a.userDetailsLink=p,a.users=new k,a.usersTable=t(),a.state={activeTab:"Users",siteUrl:"",sourceGroup:"",userFilter:"",groupFilter:""},j()}]),angular.module("angularPoint").run(["$templateCache",function(a){a.put("bower_components/angular-point-group-manager/src/group_manager_view.html",'<style>select.multiselect {\n        min-height: 400px;\n    }\n\n    .ui-match {\n        background: yellow;\n    }</style><div class=container><ul class="nav nav-tabs"><li ng-class="{active: state.activeTab === \'Users\'}"><a href ng-click="updateTab(\'Users\')">Users</a></li><li ng-class="{active: state.activeTab === \'Groups\'}"><a href ng-click="updateTab(\'Groups\')">Groups</a></li><li ng-class="{active: state.activeTab === \'Merge\'}"><a href ng-click="state.activeTab = \'Merge\'">Merge</a></li><li ng-class="{active: state.activeTab === \'UserList\'}"><a href ng-click="state.activeTab = \'UserList\'">User List</a></li><li ng-class="{active: state.activeTab === \'GroupList\'}"><a href ng-click="state.activeTab = \'GroupList\'">Group List</a></li></ul><div ng-if="state.activeTab === \'Users\'"><div class="panel panel-default"><div class=panel-heading><div class=row><div class=col-xs-5><span style=font-weight:bold>Select a Group:</span><select class=form-control ng-model=users.filter ng-options="group.Name for group in groups.all" ng-change=updateAvailableUsers(users.filter) style="min-width: 100px"></select></div><div class=col-xs-7><span style=font-weight:bold>Site/Site Collection:</span> <input class=form-control ng-model=state.siteUrl ng-change=updateAvailableUsers(users.filter)></div></div><div class=row ng-if=users.filter.Description><div class=col-xs-12><p class=help-block>Description: {{ users.filter.Description }}</p></div></div></div><div class=panel-body><div class=row><div class=col-xs-12><div colspan=3 class=description>This tab will allow you to quickly assign multiple users to a selected group.</div></div></div><hr class=hr-sm><div class=row><div class=col-xs-5><div class=form-group><label>Available Users ({{users.available.length}})</label><select ng-model=users.selectedAvailable ng-options="user.Name for user in users.available" multiple class="multiselect form-control"></select></div></div><div class="col-xs-2 text-center" style="padding-top: 175px"><button class="btn btn-default" style=width:80px ng-click="updatePermissions(\'AddUserToGroup\', users.selectedAvailable, [users.filter])" title="Add user"><i class="fa fa-2x fa-angle-double-right"></i></button><br><br><button class="btn btn-default" style=width:80px ng-click="updatePermissions(\'RemoveUserFromGroup\', users.selectedAssigned, [users.filter])"><i class="fa fa-2x fa-angle-double-left"></i></button></div><div class=col-xs-5><div class=form-group><label>Assigned Users ({{users.assigned.length}})</label><select ng-model=users.selectedAssigned ng-options="user.Name for user in users.assigned" multiple class="multiselect form-control"></select></div></div></div></div></div></div><div ng-if="state.activeTab === \'Groups\'"><div class="panel panel-default"><div class=panel-heading><div class=row><div class=col-xs-5><span style=font-weight:bold>Select a User:</span><select class=form-control ng-model=groups.filter ng-options="user.Name for user in users.all" ng-change=updateAvailableGroups(groups.filter) style="min-width: 100px"></select></div><div class=col-xs-7><span style=font-weight:bold>Site/Site Collection:</span> <input class=form-control ng-model=state.siteUrl ng-change=updateAvailableGroups(groups.filter)></div></div></div><div class=panel-body><div class=row><div class=col-xs-12><div colspan=3 class=description>This page was created to make the process of managing users/groups within the site collection more manageable. When a user is selected, the available groups are displayed on the left and the groups that the user is currently a member of will show on the right. Selecting multiple groups is supported.</div></div></div><hr class=hr-sm><div class=row><div class=col-xs-5><div class=form-group><label>Available Groups ({{groups.available.length}})</label><select ng-model=groups.selectedAvailable ng-options="group.Name for group in groups.available" multiple class="multiselect form-control"></select></div></div><div class="col-xs-2 text-center" style="padding-top: 175px"><button class="btn btn-default" style=width:80px ng-click="updatePermissions(\'AddUserToGroup\', [groups.filter], groups.selectedAvailable)" title="Add to group"><i class="fa fa-2x fa-angle-double-right"></i></button><br><br><button class="btn btn-default" style=width:80px ng-click="updatePermissions(\'RemoveUserFromGroup\', [groups.filter], groups.selectedAssigned)"><i class="fa fa-2x fa-angle-double-left"></i></button></div><div class=col-xs-5><div class=form-group><label>Assigned Users ({{users.assigned.length}})</label><select ng-model=groups.selectedAssigned ng-options="group.Name for group in groups.assigned" multiple class="multiselect form-control"></select></div></div></div></div></div></div><div ng-if="state.activeTab === \'Merge\'"><div class="panel panel-default"><div class=panel-body><div class=row><div class=col-xs-12><div class=description>This tab allows us to copy the members from the "Source" group over to the "Target" group. It\'s not a problem if any of the users already exist in the destination group. Note: This is a onetime operation so any additional members added to the Source group will not automatically be added to the destination group. You will need to repeat this process.</div></div></div><hr class=hr-sm><div class=row><div class=col-xs-5><fieldset><legend>Step 1</legend><div class=well><div class=form-group><label>Source Group</label><select class=form-control ng-model=state.sourceGroup ng-options="group.Name for group in groups.all" ng-change=updateAvailableUsers(state.sourceGroup) style="min-width: 100px"></select></div></div></fieldset></div><div class=col-xs-5><fieldset><legend>Step 2</legend><div class=well><div class=form-group><label>Source Group</label><select class=form-control ng-model=state.targetGroup ng-options="group.Name for group in groups.all" style="min-width: 100px"></select></div></div></fieldset></div><div class=col-xs-2><fieldset><legend>Step 3</legend><button class="btn btn-success" ng-disabled="state.sourceGroup.length < 1 || state.targetGroup.length < 1" ng-click=mergeGroups() title="Copy all members from the source group over to the destination group."><i class="fa fa-2x fa-magic"></i> Merge</button></fieldset></div></div></div></div></div><div ng-if="state.activeTab === \'UserList\'"><div class="panel panel-default"><div class=panel-heading><span style=font-weight:bold>User Filter</span> <input class=form-control ng-model=state.userFilter ng-change=usersTable.reload()></div><table ng-table=usersTable class=table template-pagination=custom/pager><tr ng-repeat="user in $data"><td data-title="\'ID\'">{{ user.ID }}</td><td data-title="\'Name\'"><a href ng-click=userDetailsLink(user) ng-bind-html="user.Name |  highlight:state.userFilter"></a></td><td data-title="\'Email\'">{{ user.Email }}</td></tr></table></div></div><div ng-if="state.activeTab === \'GroupList\'"><div class="panel panel-default"><div class=panel-heading><span style=font-weight:bold>Group Filter</span> <input class=form-control ng-model=state.groupFilter ng-change=groupsTable.reload()></div><table ng-table=groupsTable class=table template-pagination=custom/pager><tr ng-repeat="group in $data"><td data-title="\'ID\'">{{ group.ID }}</td><td data-title="\'Name\'"><a href ng-click=groupDetailsLink(group) ng-bind-html="group.Name |  highlight:state.groupFilter"></a></td><td data-title="\'Description\'">{{ group.Description }}</td></tr></table></div></div></div><script type=text/ng-template id=custom/pager><div class="row">\n        <div class="col-xs-12">\n            <ul class="pager ng-cloak">\n                <li ng-repeat="page in pages"\n                    ng-class="{\'disabled\': !page.active}"\n                    ng-show="page.type == \'prev\' || page.type == \'next\'" ng-switch="page.type">\n                    <a ng-switch-when="prev" ng-click="params.page(page.number)" href="">\n                        <i class="fa fa-chevron-left"></i>\n                    </a>\n                    <a ng-switch-when="next" ng-click="params.page(page.number)" href="">\n                        <i class="fa fa-chevron-right"></i>\n                    </a>\n                </li>\n            </ul>\n        </div>\n    </div></script>')}]);